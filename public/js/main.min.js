const urlParams=new URLSearchParams(window.location.search),timestamp=urlParams.get("ts");let date=new Date,map=(!timestamp||0<(date=new Date(1e3*Number(timestamp))).getTime()||(date=new Date),$(document).ready(function(){$("#datePicker").datepicker({format:"dd-mm-yyyy",autoclose:!0,todayHighlight:!0,startDate:"2011-04-19",startView:0,maxViewMode:2,endDate:"+0d"}).datepicker("setDate",date).on("changeDate",function(e){var e=e.date;e.toDateString()===(new Date).toDateString()?window.location.href=window.location.pathname:(e=e.getTime()/1e3,urlParams.set("ts",String(e)),window.location.search=urlParams.toString())})}),new maplibregl.Map({container:"map",style:"https://api.maptiler.com/maps/streets/style.json?key=FmkZcpxnyFTMyvbqcIqk",center:[0,33],zoom:2.2,attributionControl:!1})),disasterCookie=($(window).resize(function(){map.resize()}),map.addControl(new maplibregl.AttributionControl({compact:!1,customAttribution:'<a href="/about">About &amp; Privacy</a>'}),"bottom-right"),map.addControl(new maplibregl.NavigationControl,"bottom-right"),localStorage.getItem("disaster")),reportCookie=localStorage.getItem("report"),newsCookie=localStorage.getItem("news"),showEventDurationCookie=localStorage.getItem("showEventDuration"),onlyNewDataCookie=localStorage.getItem("onlyNewData"),markers=(disasterCookie||(localStorage.setItem("disaster","true"),disasterCookie="true"),reportCookie||(localStorage.setItem("report","true"),reportCookie="true"),newsCookie||(localStorage.setItem("news","true"),newsCookie="true"),showEventDurationCookie||(localStorage.setItem("showEventDuration","false"),showEventDurationCookie="false"),onlyNewDataCookie||(localStorage.setItem("onlyNewData","false"),onlyNewDataCookie="false"),$("#disasterCheckbox").prop("checked","true"===disasterCookie),$("#reportCheckbox").prop("checked","true"===reportCookie),$("#newsCheckbox").prop("checked","true"===newsCookie),$("#showEventDurationCheckbox").prop("checked","true"===showEventDurationCookie),$("#onlyNewDataCheckbox").prop("checked","true"===onlyNewDataCookie),$("#showEventDurationCheckbox").change(function(){localStorage.setItem("showEventDuration",this.checked),$(".eventDuration").toggle(this.checked)}),$("#onlyNewDataCheckbox").change(function(){localStorage.setItem("onlyNewData",this.checked),window.location.reload()}),timestamp&&$("#newsCheckboxDiv").hide(),[]),firstSymbolId,feedbacksAwaited=0,sourceData=[null,null,null],sourceColors=[null,null,null],sourceGeoJSON=[null,null,null];const worker=new Worker("/js/main-load-worker.min.js"),mapLoaded=new Promise(e=>{map.on("load",e)});function feedbackReceived(){if(0===--feedbacksAwaited){setLoading(!1),localStorage.getItem("settingsShown")||(clickSettingsButton(null),localStorage.setItem("settingsShown","true")),markers.sort((e,t)=>t.date-e.date),$("#articlesList").empty();for(let e=articlesListScrollState=0;e<markers.length;e++){var t=document.createElement("div");t.innerHTML=markers[e].articleDescription,t.classList.add("article-"+markers[e].source),$("#articlesList").append(t)}}}worker.onmessage=async function(e){setLoading(!0);var[e,t,o,a]=[e.data.source,e.data.serverData,e.data.geoJSON,e.data.colors],r=["disaster","report","news"][e];if(sourceData[e]=t,sourceGeoJSON[e]=o,sourceColors[e]=a,await mapLoaded,useGeoJSON){if(!firstSymbolId){var s=map.getStyle().layers;for(let e=0;e<s.length;e++)if("symbol"===s[e].type){firstSymbolId=s[e].id;break}}map.addSource(r,{type:"geojson",data:o}),map.addLayer({id:r+"-layer",type:"fill",source:r,layout:{},paint:{"fill-color":["get","fill"],"fill-opacity":.32}},firstSymbolId)}addMarkers(map,markers,t,a,e);for(const n of markers){var i=markers.filter(e=>e.lat===n.lat&&e.lon===n.lon);1<i.length&&(i=32*(i.indexOf(n)-(i.length-1)/2),n.setOffset([i,0]))}feedbackReceived()},worker.onerror=function(e){console.error(e),feedbackReceived()},"true"===disasterCookie&&(worker.postMessage({source:0,useGeoJSON:useGeoJSON,dateOfTimestamp:date,onlyNewData:onlyNewDataCookie,timestamp:timestamp}),feedbacksAwaited++),"true"===reportCookie&&(worker.postMessage({source:1,useGeoJSON:useGeoJSON,dateOfTimestamp:date,onlyNewData:onlyNewDataCookie,timestamp:timestamp}),feedbacksAwaited++),"true"===newsCookie&&(worker.postMessage({source:2,useGeoJSON:useGeoJSON,dateOfTimestamp:date,onlyNewData:onlyNewDataCookie,timestamp:timestamp}),feedbacksAwaited++),0===feedbacksAwaited&&setLoading(!1);for(const w of["disaster","report","news"])$(`#${w}Checkbox`).change(function(){localStorage.setItem(w,String(this.checked));var e=["disaster","report","news"].indexOf(w);this.checked&&null===sourceData[e]?(setLoading(!0),worker.postMessage({source:e,useGeoJSON:useGeoJSON,dateOfTimestamp:date,onlyNewData:onlyNewDataCookie,timestamp:timestamp}),feedbacksAwaited++):($(".article-"+e).toggle(this.checked),articlesListScrollState=0,toggleLayer(map,markers,w+"-layer",this.checked))});map.on("click",e=>{var t=e.originalEvent.target;let o=!1;for(const a of markers)if(a.getElement().contains(t)){$(a.getElement()).effect("highlight",{color:a.color},100),a===selectedMarker?closeSideBar():openSideBar(a),o=!0;break}o||(closeSideBar(),clickSettingsButton(!0))});