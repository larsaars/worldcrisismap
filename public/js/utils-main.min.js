let sidebarIsClosed=!0,selectedMarker=null,lastSelectedMarker=null,settingsOpened=!1,loading=!0,datePickerDivHiddenOnSidebar=!1,useGeoJSON,articlesListScrollState=0,isFlying=!1;function pageIsMobileFormat(){return 1.4<=$(window).innerHeight()/$(window).innerWidth()}function setLoading(e){e!==loading&&(e?$("#earth").show():$("#earth").hide(),$("#settings").animate({width:"toggle",height:"toggle"}),$("#articlesButtonDiv").animate({width:"toggle"}),loading=e)}function hexToRgb(e){e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(e,t,i,a){return t+t+i+i+a+a});e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function useBlack(e){e=hexToRgb(e);return 150<(299*e.r+587*e.g+114*e.b)/1e3}function getGeoJSONFromEvent(e,t){var i={type:"FeatureCollection",features:[]};for(const a of e.features)a.properties.eventIndex===t&&i.features.push(a);return i}function getMarkerImagePath(e,t){return"/markers/"+(t?"black":"white")+"/"+e.toLowerCase().replace(/ /g,"_")+".png"}function toggleDatePickerDiv(e){e=e||pageIsMobileFormat();var t=$("#datePickerDiv");t.css("top",e?"auto":"0"),t.css("bottom",e?"0":"auto"),t.css("border-radius",e?"1rem 1rem 0 0":"0 0 1rem 1rem"),t.animate({height:"toggle"},{duration:200})}function hideArticlesList(){articlesListScrollState=$("#sidebarContent").scrollTop(),$("#articlesListDiv").hide(),$("#articlesButtonDiv").animate({width:"show"}),$("#articlesListButtonBack").hide(),$("#articlesListButtonList").show()}function showArticlesList(){$("#articlesListDiv").show(),$("#sidebarContent").scrollTop(articlesListScrollState),$("#articlesButtonDiv").animate({width:"hide"}),null!==lastSelectedMarker&&$("#articlesListButtonBack").show(),$("#articlesListButtonList").hide()}function sleep(t){return new Promise(e=>setTimeout(e,t))}async function blinkLayerAndMarker(t,i,a=3){for(let e=0;e<a;e++)await sleep(200),map.setLayoutProperty(t,"visibility","none"),null!==i&&$(i.getElement()).hide(),await sleep(200),map.setLayoutProperty(t,"visibility","visible"),null!==i&&$(i.getElement()).show()}async function openSideBar(e,t=!1){const i=null!==e;var a=i?hexToRgb(e.color):{r:0,g:0,b:0},r=$("#sidebar"),s=$("#sidebarContent"),l=pageIsMobileFormat(),o=l?"100%":"42%";s.css("background",`rgba(${a.r}, ${a.g}, ${a.b}, 0.19)`),i&&!1===e.descriptionLoaded&&200===(a=await fetch("/api/text/"+["disaster","report","news"][e.source]+"/"+e.id)).status&&(a=await a.text(),e.descriptionLoaded=!0,e.description+=a.replace(/&quot;/g,'"')),sidebarIsClosed?(r.css("width",o),r.animate({width:"toggle"},{complete:function(){i?($("#sidebarText").html(e.description),$("#sidebarText a").attr("target","_blank")):$("#sidebarText").text("")}}),i?($("#articlesListButtonList").show(),$("#articlesListButtonBack").hide()):$("#articlesButtonDiv").animate({width:"hide"}),l&&($("#settings").animate({width:"toggle",height:"toggle"}),$("#datePickerDiv").is(":visible")&&(datePickerDivHiddenOnSidebar=!0,$("#datePickerDiv").animate({height:"toggle"})))):i?(hideArticlesList(),lastSelectedMarker=null,$("#sidebarText").html(e.description),$("#sidebarText a").attr("target","_blank"),s.scrollTop(0)):(lastSelectedMarker=selectedMarker,showArticlesList(),$("#sidebarText").text("")),i&&useGeoJSON&&(a=getGeoJSONFromEvent(sourceGeoJSON[e.source],e.eventIndex),!sidebarIsClosed&&map.getLayer("marked-layer")&&(map.removeLayer("marked-layer"),map.removeSource("marked")),map.addSource("marked",{type:"geojson",data:a}),map.addLayer({id:"marked-layer",type:"fill",source:"marked",layout:{},paint:{"fill-color":["get","fill"],"fill-opacity":.9}})),i&&t&&(map.flyTo({center:{lat:e.lat,lng:e.lon},offset:l?[0,0]:[.21*window.innerWidth,0]}),isFlying=!0),sidebarIsClosed=!1,selectedMarker=i?e:null}function openArticlesList(){showArticlesList(),openSideBar(null)}function closeSideBar(){var e;sidebarIsClosed||(e=pageIsMobileFormat(),$("#sidebar").animate({width:"toggle"},{complete:function(){$("#sidebarText").html("")}}),!e&&$("#settings").is(":visible")||$("#settings").animate({width:"toggle",height:"toggle"}),$("#articlesButtonDiv").animate({width:"show"}),datePickerDivHiddenOnSidebar&&(datePickerDivHiddenOnSidebar=!1,toggleDatePickerDiv(e)),useGeoJSON&&map.getLayer("marked-layer")&&(map.removeLayer("marked-layer"),map.removeSource("marked")),$("#articlesListDiv").hide(),sidebarIsClosed=!0,lastSelectedMarker=null,selectedMarker=null,articlesListScrollState=0)}function clickSettingsButton(e){loading||null!==e&&e!==settingsOpened||($("#settingsButton").animate({degrees:settingsOpened?-180:180},{duration:180,step:function(e){$(this).css({transform:"rotate("+e+"deg)"})},complete:function(){settingsOpened=!settingsOpened}}),$("#settingsPanel").animate({width:"toggle",height:"toggle"},{duration:200}),toggleDatePickerDiv(null))}function addMarkers(t,i,a,r,s){for(let e=0;e<a.length;e++){var l=a[e],o=[l.type,"ReliefWeb Report","IPS News Article"][s],n=useBlack(r[e]),n=getMarkerImagePath(l.type,n),d=new Date(l.date),c=document.createElement("div"),g=(c.title=l.title,c.style.width="32px",c.style.height="32px",c.style.backgroundSize="contain",c.style.cursor="pointer",c.style.backgroundColor=r[e],c.style.borderRadius="50%",c.style.border="1px solid "+r[e],c.style.opacity="0.72",c.style.backgroundImage=`url(${n})`,document.createElement("div")),u=(c.appendChild(g),g.style.width="18px",g.style.height="18px",g.style.backgroundColor="red",g.style.borderRadius="50%",g.style.backgroundSize="contain",g.style.color="white",g.style.opacity="0.9",g.style.border="1px solid red",g.classList.add("topRightText"),g.classList.add("eventDuration"),g.style.display="true"===showEventDurationCookie?"block":"none",document.createElement("div")),g=(g.appendChild(u),u.textContent=l.daysSinceEvent,u.style.fontSize="0.8rem",u.classList.add("absoluteCenter"),new maplibregl.Marker(c,{color:r[e],draggable:!1,anchor:"center"}).setLngLat([l.lon,l.lat])),u=d.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),c=n.replace(/white/g,"black");g.description=`<div><img src="${c}" alt="event type" style="width: 2rem; height: 2rem; margin-bottom: 0.5rem"><br><i>`+o+"</i></div><p><small>"+u+'</small></p><h2><a href="'+l.url+'">'+l.title+"</a></h2><br>",g.descriptionLoaded=!1,g.articleDescription=`<div class="p-1" style="display: inline-flex"><img src="${c}" alt="event type" style="width: 2rem; height: 2rem; float: left">`+`<button class="link ms-2" onclick="onArticleClick(${l.id})">`+l.title+" <small>("+u+")</small></button></div>",g.id=l.id,g.color=r[e],g.eventIndex=Number(e),g.source=s,g.lat=l.lat,g.lon=l.lon,g.date=d,g.addTo(t),i.push(g)}}function onArticleClick(t){openSideBar(markers.find(e=>e.id===t),!0)}function toggleLayer(e,t,i,a){useGeoJSON&&e.setLayoutProperty(i,"visibility",a?"visible":"none");const r={0:"disaster-layer",1:"report-layer",2:"news-layer"};t.filter(e=>i===r[e.source]).forEach(e=>e.getElement().style.display=a?"block":"none")}useGeoJSON=!pageIsMobileFormat();