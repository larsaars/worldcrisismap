let sidebarIsClosed=!0,selectedMarker=null,settingsOpened=!1,loading=!0,datePickerDivHiddenOnSidebar=!1,useGeoJSON;function pageIsMobileFormat(){return 1.4<=$(window).innerHeight()/$(window).innerWidth()}function setLoading(e){e!==loading&&(e?$("#earth").show():$("#earth").hide(),$("#settings").animate({width:"toggle",height:"toggle"}),$("#articlesButtonDiv").animate({width:"toggle"}),loading=e)}function hexToRgb(e){e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(e,t,i,a){return t+t+i+i+a+a});e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function useBlack(e){e=hexToRgb(e);return 150<(299*e.r+587*e.g+114*e.b)/1e3}function getGeoJSONFromEvent(e,t){var i={type:"FeatureCollection",features:[]};for(const a of e.features)a.properties.eventIndex===t&&i.features.push(a);return i}function getMarkerImagePath(e,t){return"/markers/"+(t?"black":"white")+"/"+e.toLowerCase().replace(/ /g,"_")+".png"}function toggleDatePickerDiv(e){e=e||pageIsMobileFormat();var t=$("#datePickerDiv");t.css("top",e?"auto":"0"),t.css("bottom",e?"0":"auto"),t.css("border-radius",e?"1rem 1rem 0 0":"0 0 1rem 1rem"),t.animate({height:"toggle"},{duration:200})}async function openSideBar(e){const t=null!==e;var i=t?hexToRgb(e.color):{r:0,g:0,b:0},a=$("#sidebar"),r=$("#sidebarContent"),o=pageIsMobileFormat(),n=o?"100%":"42%";r.css("background",`rgba(${i.r}, ${i.g}, ${i.b}, 0.19)`),t&&!1===e.descriptionLoaded&&200===(i=await fetch("/api/text/"+["disaster","report","news"][e.source]+"/"+e.id)).status&&(i=await i.text(),e.descriptionLoaded=!0,e.description+=i.replace(/&quot;/g,'"')),sidebarIsClosed?(a.css("width",n),a.animate({width:"toggle"},{complete:function(){t?($("#sidebarText").html(e.description),$("#sidebarText a").attr("target","_blank")):($("#articlesListDiv").show(),$("#sidebarText").text(""))}}),$("#articlesButtonDiv").animate({width:"hide"}),o&&($("#settings").animate({width:"toggle",height:"toggle"}),$("#datePickerDiv").is(":visible")&&(datePickerDivHiddenOnSidebar=!0,$("#datePickerDiv").animate({height:"toggle"})))):t?($("#articlesButtonDiv").animate({width:"toggle"}),$("#articlesListDiv").hide(),$("#sidebarText").html(e.description),$("#sidebarText a").attr("target","_blank"),r.scrollTop(0)):($("#articlesListDiv").show(),$("#sidebarText").text("")),t&&useGeoJSON&&(i=getGeoJSONFromEvent(sourceGeoJSON[e.source],e.eventIndex),!sidebarIsClosed&&map.getLayer("marked-layer")&&(map.removeLayer("marked-layer"),map.removeSource("marked")),map.addSource("marked",{type:"geojson",data:i}),map.addLayer({id:"marked-layer",type:"fill",source:"marked",layout:{},paint:{"fill-color":["get","fill"],"fill-opacity":.9}})),sidebarIsClosed=!1,selectedMarker=t?e:null}function openArticlesList(){$("#articlesButtonDiv").animate({width:"hide"}),openSideBar(null)}function closeSideBar(){var e;sidebarIsClosed||(e=pageIsMobileFormat(),$("#sidebar").animate({width:"toggle"},{complete:function(){$("#sidebarText").html("")}}),!e&&$("#settings").is(":visible")||$("#settings").animate({width:"toggle",height:"toggle"}),$("#articlesButtonDiv").animate({width:"show"}),datePickerDivHiddenOnSidebar&&(datePickerDivHiddenOnSidebar=!1,toggleDatePickerDiv(e)),useGeoJSON&&map.getLayer("marked-layer")&&(map.removeLayer("marked-layer"),map.removeSource("marked")),$("#articlesListDiv").hide(),sidebarIsClosed=!0,selectedMarker=null)}function clickSettingsButton(e){loading||null!==e&&e!==settingsOpened||($("#settingsButton").animate({degrees:settingsOpened?-180:180},{duration:180,step:function(e){$(this).css({transform:"rotate("+e+"deg)"})},complete:function(){settingsOpened=!settingsOpened}}),$("#settingsPanel").animate({width:"toggle",height:"toggle"},{duration:200}),toggleDatePickerDiv(null))}function addMarkers(t,i,a,r,o){for(let e=0;e<a.length;e++){var n=a[e],s=[n.type,"ReliefWeb Report","IPS News Article"][o],l=useBlack(r[e]),l=getMarkerImagePath(n.type,l),d=new Date(n.date),c=document.createElement("div"),g=(c.title=n.title,c.style.width="32px",c.style.height="32px",c.style.backgroundSize="contain",c.style.cursor="pointer",c.style.backgroundColor=r[e],c.style.borderRadius="50%",c.style.border="1px solid "+r[e],c.style.opacity="0.72",c.style.backgroundImage=`url(${l})`,document.createElement("div")),u=(c.appendChild(g),g.style.width="18px",g.style.height="18px",g.style.backgroundColor="red",g.style.borderRadius="50%",g.style.backgroundSize="contain",g.style.color="white",g.style.opacity="0.9",g.style.border="1px solid red",g.classList.add("topRightText"),g.classList.add("eventDuration"),g.style.display="true"===showEventDurationCookie?"block":"none",document.createElement("div")),g=(g.appendChild(u),u.textContent=n.daysSinceEvent,u.style.fontSize="0.8rem",u.classList.add("absoluteCenter"),new maplibregl.Marker(c,{color:r[e],draggable:!1,anchor:"center"}).setLngLat([n.lon,n.lat])),u=d.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),c=l.replace(/white/g,"black");g.description=`<div><img src="${c}" alt="event type" style="width: 2rem; height: 2rem; margin-bottom: 0.5rem"><br><i>`+s+"</i></div><p><small>"+u+'</small></p><h2><a href="'+n.url+'">'+n.title+"</a></h2><br>",g.descriptionLoaded=!1,g.articleDescription=`<div class="p-1" style="display: inline-flex"><img src="${c}" alt="event type" style="width: 2rem; height: 2rem; float: left">`+`<button class="link ms-2" onclick="onArticleClick(${n.id})">`+n.title+" <small>("+u+")</small></button></div>",g.id=n.id,g.color=r[e],g.eventIndex=Number(e),g.source=o,g.lat=n.lat,g.lon=n.lon,g.addTo(t),i.push(g)}}function onArticleClick(t){openSideBar(markers.find(e=>e.id===t))}function toggleLayer(e,t,i,a){useGeoJSON&&e.setLayoutProperty(i,"visibility",a?"visible":"none");const r={0:"disaster-layer",1:"report-layer",2:"news-layer"};t.filter(e=>i===r[e.source]).forEach(e=>e.getElement().style.display=a?"block":"none")}useGeoJSON=!pageIsMobileFormat();